name: Test Docker Turtlesim Launch

on:
  push:
    branches: [ develop, main ]
    paths:
      - 'examples/5_docker_turtlesim/**'
      - '.github/workflows/test-docker-turtlesim.yml'
  pull_request:
    branches: [ develop, main ]
    paths:
      - 'examples/5_docker_turtlesim/**'

jobs:
  test-docker-build:
    name: Test Docker Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13]
    
    defaults:
      run:
        working-directory: examples/5_docker_turtlesim

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker on macOS
        if: runner.os == 'macOS'
        run: |
          brew install docker docker-compose colima
          colima start --memory 4 --cpu 2
          
      - name: Build Docker image
        run: docker compose build turtlesim
        timeout-minutes: 15

      - name: Test container can start (headless)
        run: |
          # Set headless display for testing
          export DISPLAY=:99
          export QT_QPA_PLATFORM=offscreen
          
          # Start container in detached mode
          timeout 60 docker compose up -d turtlesim || echo "Container start timeout"
          
          # Wait for services to initialize
          sleep 15
          
          # Check if container is running
          docker ps -a
          
          # Check container logs for errors
          docker compose logs turtlesim
          
      - name: Test ROS Bridge WebSocket
        run: |
          # Check if rosbridge websocket server started
          docker compose logs turtlesim | grep -i "rosbridge" || echo "Rosbridge log check"
          
          # Try to connect to port 9090 (may not work without proper setup)
          timeout 10 bash -c 'until curl -s http://localhost:9090 2>/dev/null; do sleep 1; done' || echo "Rosbridge connection test skipped in CI"

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v || true
          if [ "${{ runner.os }}" == "macOS" ]; then
            colima stop || true
          fi

  test-launch-scripts:
    name: Validate Launch Scripts
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: examples/5_docker_turtlesim

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Make scripts executable
        run: |
          chmod +x launch.sh
          chmod +x docker/scripts/*.sh

      - name: Test script syntax
        run: |
          bash -n launch.sh
          bash -n docker/scripts/launch_linux.sh
          bash -n docker/scripts/launch_macos.sh
          bash -n docker/scripts/launch_windows.sh
          echo "All scripts have valid syntax"

      - name: Run shellcheck
        run: |
          shellcheck launch.sh || echo "Shellcheck warnings in launch.sh"
          shellcheck docker/scripts/launch_linux.sh || echo "Shellcheck warnings in launch_linux.sh"
          shellcheck docker/scripts/launch_macos.sh || echo "Shellcheck warnings in launch_macos.sh"
          shellcheck docker/scripts/launch_windows.sh || echo "Shellcheck warnings in launch_windows.sh"

      - name: Verify platform scripts exist
        run: |
          test -f docker/scripts/launch_linux.sh || exit 1
          test -f docker/scripts/launch_macos.sh || exit 1
          test -f docker/scripts/launch_windows.sh || exit 1
          echo "All platform-specific scripts found"

      - name: Verify launch.sh references platform scripts
        run: |
          grep -q "docker/scripts/launch_macos.sh" launch.sh || exit 1
          grep -q "docker/scripts/launch_linux.sh" launch.sh || exit 1
          grep -q "docker/scripts/launch_windows.sh" launch.sh || exit 1
          echo "launch.sh correctly references all platform scripts"

      - name: Test OS detection logic
        run: |
          # Test that the script can identify OS types
          grep -q "Darwin\*)" launch.sh || exit 1
          grep -q "Linux\*)" launch.sh || exit 1
          grep -q "MINGW\*|MSYS\*|CYGWIN\*)" launch.sh || exit 1
          echo "OS detection logic verified"

